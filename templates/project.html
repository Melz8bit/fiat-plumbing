<!DOCTYPE html>
<html lang="en">

<head>
    <title>Fiat Plumbing - {{ project['name'] }}</title>

    {% include 'bootstrap.html' %}

    <style>
        * {
            font-family: "Raleway", sans-serif;
        }
    </style>
</head>

<body>
    {% include 'nav.html' %}

    <div class="container pt-4">
        <div class="row d-flex align-items-center mb-4">
            <div class="col">
                <h1 class="display-5">{{ project['name'] }}</h1>
            </div>
            <div class="col text-end">
                <button class="btn btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#modalProposalCreation">Create
                    Proposal</button>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modalProposalCreation" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
                <div class="modal-content">
                    {% include 'proposal_create.html' %}
                </div>
            </div>
        </div>

        <!-- Project Info -->
        <div>
            <div class=" row">
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Contract #</span>
                        <input type="text" class="form-control" value="{{ project['project_id'] }}" aria-label="address"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Client</span>
                        <input type="text" class="form-control" value="{{ project['client_name'] }}"
                            aria-label="address" aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <form id="projectStatusForm" method="POST">
                        {{ project_status_form.hidden_tag() }}
                        <div class="input-group mb-3">
                            {{ project_status_form.project_status.label(class="input-group-text")}}
                            <select class="form-select" name="project_status" id="project_status">
                                <option selected disabled value="{{ project['status'] }}">
                                    {{ project['status'] }}
                                </option>
                                <option disabled>
                                    ─────────────────────────
                                </option>
                                {% for status in project_status_form.project_status %}
                                {% if status == project['status'] %}
                                <option disabled value="">
                                    {{ project['status'] }}
                                </option>
                                {% else %}
                                {{ status }}
                                {% endif %}
                                {% endfor %}
                            </select>
                            {{ project_status_form.project_status_update_submit(class="btn btn-outline-primary")}}
                        </div>
                    </form>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Status Date</span>
                        <input type="text" class="form-control"
                            value="{{ project['status_date'].strftime('%m/%d/%Y') }}" aria-label="address"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Info -->
        <h4 class="my-3">Location Information</h4>
        <hr>
        <div>
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Address</span>
                        <input type="text" class="form-control" value="{{ project['address'] }}" aria-label="address"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">City</span>
                        <input type="text" class="form-control" value="{{ project['city'] }}" aria-label="city"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">State</span>
                        <input type="text" class="form-control" value="{{ project['state'] }}" aria-label="state"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Zip Code</span>
                        <input type="text" class="form-control" value="{{ project['zip_code'] }}" aria-label="zipCode"
                            aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permits -->
        <!-- {#<h4 class="my-3">Permit Information</h4>
        <hr>
        <div>
            <div class="row">
                <div class="col">
                    {% if master_permit %}
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Master Permit</span>
                        <input type="text" class="form-control" value="{{ master_permit['permit_number'] }}"
                            aria-label="address" aria-describedby="basic-addon1" readonly>
                    </div>
                    {% else %}
                    <form method="POST">
                        <div class="input-group mb-3">
                            {{ master_form.hidden_tag() }}
                            {{ master_form.master_permit.label(class="input-group-text") }}
                            {{ master_form.master_permit(class="form-control") }}
                            {{ master_form.add(class="btn btn-outline-primary")}}

                        </div>
                    </form>
                    {% endif %}
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Plumbing Permit</span>
                        <input type="text" class="form-control" value="{{ plumbing_permit['permit_number'] }}"
                            aria-label="city" aria-describedby="basic-addon1" readonly>
                        {% if not plumbing_permit %}
                        <button class="btn btn-outline-primary" type="button" id="button-addon2">Request</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div> #}-->

        <hr>

        <!-- Submenu Nav -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <!-- <button class="nav-link active" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-tab-pane"
                    type="button" role="tab" aria-controls="notes-tab-pane" aria-selected="true">Notes</button> -->
                <button class="nav-link active" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-tab-pane"
                    type="button" role="tab" aria-controls="notes-tab-pane" aria-selected="true"
                    data-url="{{ url_for('get_project_notes', project_id=project['project_id']) }}">Notes</button>
            </li>
            <li class="nav-item" role="presentation">
                <!-- <button class="nav-link" id="fixtures-tab" data-bs-toggle="tab" data-bs-target="#fixtures-tab-pane"
                    type="button" role="tab" aria-controls="fixtures-tab-pane" aria-selected="false">Fixtures</button> -->
                <button class="nav-link" id="fixtures-tab" data-bs-toggle="tab" data-bs-target="#fixtures-tab-pane"
                    type="button" role="tab" aria-controls="fixtures-tab-pane" aria-selected="false"
                    data-url="{{ url_for('get_project_fixtures', project_id=project['project_id']) }}">Fixtures</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="installments-tab" data-bs-toggle="tab"
                    data-bs-target="#installments-tab-pane" type="button" role="tab"
                    aria-controls="installments-tab-pane" aria-selected="false"
                    data-url="{{ url_for('get_project_installments', project_id=project['project_id']) }}">Installments</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-tab-pane"
                    type="button" role="tab" aria-controls="invoices-tab-pane" aria-selected="false"
                    data-url="{{ url_for('get_project_invoices', project_id=project['project_id']) }}">Invoices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-tab-pane"
                    type="button" role="tab" aria-controls="payments-tab-pane" aria-selected="false"
                    data-url="{{ url_for('get_project_payments', project_id=project['project_id']) }}">Payments</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="permits-tab" data-bs-toggle="tab" data-bs-target="#permits-tab-pane"
                    type="button" role="tab" aria-controls="permits-tab-pane" aria-selected="false"
                    data-url="{{ url_for('get_project_permits', project_id=project['project_id']) }}">Permits</button>
            </li>
            <!-- 
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inspections-tab" data-bs-toggle="tab"
                    data-bs-target="#inspections-tab-pane" type="button" role="tab" aria-controls="inspections-tab-pane"
                    aria-selected="false">Inspections</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents-tab-pane"
                    type="button" role="tab" aria-controls="documents-tab-pane" aria-selected="false">Documents</button>
            </li> -->
        </ul>

        <!-- Subsections -->
        <div class="tab-content" id="myTabContent">
            <!-- Notes -->
            <div class="tab-pane fade show active" id="notes-tab-pane" role="tabpanel" aria-labelledby="notes-tab"
                tabindex="0">
                <div class="ratio ratio-16x9">
                    {% include 'project_notes.html' %}
                </div>
            </div>

            <!-- Fixtures -->
            <div class="tab-pane fade" id="fixtures-tab-pane" role="tabpanel" aria-labelledby="fixtures-tab"
                tabindex="0">
            </div>

            <!-- Installments -->
            <div class="tab-pane fade" id="installments-tab-pane" role="tabpanel" aria-labelledby="installments-tab"
                tabindex="0">
            </div>

            <!-- Invoices -->
            <div class="tab-pane fade" id="invoices-tab-pane" role="tabpanel" aria-labelledby="invoices-tab"
                tabindex="0">
            </div>

            <!-- Payments -->
            <div class="tab-pane fade" id="payments-tab-pane" role="tabpanel" aria-labelledby="payments-tab"
                tabindex="0">
            </div>

            <!-- Permits -->
            <div class="tab-pane fade" id="permits-tab-pane" role="tabpanel" aria-labelledby="permits-tab" tabindex="0">
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const tabEl = document.getElementById('myTab');
                tabEl.addEventListener('show.bs.tab', function (event) {
                    const url = event.target.getAttribute('data-url');
                    const target = event.target.getAttribute('data-bs-target');
                    const contentPane = document.querySelector(target);

                    if (url && contentPane && contentPane.innerHTML.trim() === '') {
                        // Add a loading spinner
                        contentPane.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                        fetch(url)
                            .then(response => response.text())
                            .then(html => {
                                contentPane.innerHTML = html;
                            })
                            .catch(error => {
                                console.error('Error loading tab content:', error);
                                contentPane.innerHTML = '<p class="text-center text-danger mt-5">Failed to load content.</p>';
                            });
                    }
                });
            });
        </script>
    </div>
    {% include 'flash_message.html' %}

    <script>
        $(document).ready(function () {
            // Inject our CSRF token into our AJAX request.
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ apply_payment_form.csrf_token._value() }}")
                    }
                }
            });

            // $(document).on("click", function (e) {
            //     console.log("Clicked element:", e.target);
            // });
        });

        // Delegated binding: listens for clicks on #btnApplyPayment, even if added later
        $(document).on("click", "#btnApplyPayment", function (e) {
            // console.log("Apply button clicked!");
            e.preventDefault(); // prevent form submission

            var url = "{{ url_for('apply_payment_ajax', project_id=project['project_id']) }}";

            $.ajax({
                type: "POST",
                url: url,
                data: $('#applyPayment').serialize(), // serializes the form's elements
                success: function (data) {
                    // console.log("Response:", data);

                    let dollarString = new Intl.NumberFormat("en-US", {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                    });

                    var payment_applied = document.getElementById("payment_applied");

                    for (var i = 0; i < data.length; i++) {
                        var invoice_id = data[i]["invoice_id"];
                        var amount_applied = document.getElementById("txtInvoiceApplyPayment" + invoice_id);
                        var amount_applied_hidden = document.getElementById("invoiceApplyPayment" + invoice_id);
                        var amount_remaining = document.getElementById("txtInvoiceAmountRemaining" + invoice_id);
                        var amount_remaining_hidden = document.getElementById("invoiceAmountRemaining" + invoice_id);
                        var status = document.getElementById("txtInvoiceStatus" + invoice_id);
                        var status_hidden = document.getElementById("invoiceStatus" + invoice_id);

                        // Reset values to zero
                        amount_applied.value = "$0.00";
                        amount_applied_hidden.value = 0.00;
                        amount_remaining.value = "$0.00";
                        amount_remaining_hidden.value = 0.00;
                        status.value = "";
                        status_hidden.value = "";

                        // Apply response values
                        amount_applied.value = dollarString.format(data[i]["amount_received"]);
                        amount_applied_hidden.value = parseFloat(data[i]["amount_received"]);
                        amount_remaining.value = dollarString.format(data[i]["amount_remaining"]);
                        amount_remaining_hidden.value = parseFloat(data[i]["amount_remaining"]);
                        status.value = data[i]["invoice_status"];
                        status_hidden.value = data[i]["invoice_status"];
                    }

                    payment_applied.value = true;
                }
            });
        });

        $(document).on("click", "#apply_payment", function (e) {
            setTimeout(function () {
                $("#apply_payment").prop("disabled", true).val("Processing...");
            }, 100);
        });

        //  Permits Add
        document.addEventListener("DOMContentLoaded", function () {
            // Delegate change event for city/county select inside the modal
            document.addEventListener("change", function (e) {
                if (e.target && e.target.id === "city_county") {
                    const cityCountySelect = e.target;
                    const goLink = document.getElementById("goLink");

                    if (!goLink) return;

                    const selectedOption = cityCountySelect.options[cityCountySelect.selectedIndex];
                    const websiteUrl = selectedOption ? selectedOption.getAttribute("data-website") : null;

                    if (websiteUrl) {
                        goLink.href = websiteUrl;
                        goLink.classList.remove("disabled");
                        goLink.removeAttribute("disabled");
                    } else {
                        goLink.href = "#";
                        goLink.classList.add("disabled");
                        goLink.setAttribute("disabled", "true");
                    }
                }
            });

            // Delegate click event for the Go button inside the modal
            document.addEventListener("click", function (e) {
                if (e.target && e.target.id === "goLink") {
                    if (e.target.classList.contains("disabled")) {
                        e.preventDefault();
                    }
                }
            });
        });
    </script>

    <script>
        // Load tab on submission
        document.addEventListener("DOMContentLoaded", function () {
            const activeTab = "{{ tab }}";
            if (activeTab) {
                const tabButton = document.getElementById(activeTab + "-tab");
                if (tabButton) {
                    const tabInstance = new bootstrap.Tab(tabButton);
                    tabInstance.show();
                }
            }
        });
    </script>
</body>

</html>